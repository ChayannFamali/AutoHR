{% extends 'base.html' %}
{% load static %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–π - AutoHR{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2">
                <i class="fas fa-calendar me-2 text-primary"></i>
                –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–π
            </h1>
            <p class="text-muted">–í–∞—à–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è</p>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="btn-group" role="group">
                <a href="{% url 'calendar_app:interview_list' %}" class="btn btn-outline-primary">
                    <i class="fas fa-list me-1"></i>
                    –°–ø–∏—Å–æ–∫
                </a>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                    <i class="fas fa-plus me-1"></i>
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <button type="button" class="btn btn-outline-secondary" id="prevMonthBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                        <div class="col text-center">
                            <h4 class="mb-0" id="currentMonthYear">–î–µ–∫–∞–±—Ä—å 2024</h4>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-outline-secondary" id="nextMonthBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="col-auto">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-view="month">–ú–µ—Å—è—Ü</button>
                                <button type="button" class="btn btn-outline-primary" data-view="week">–ù–µ–¥–µ–ª—è</button>
                                <button type="button" class="btn btn-outline-primary" data-view="day">–î–µ–Ω—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0" id="calendarContainer">
                    
                    <div id="monthView" class="calendar-view">
                        <div class="calendar-grid">
                            
                            <div class="calendar-header">
                                <div class="calendar-day-header">–ü–Ω</div>
                                <div class="calendar-day-header">–í—Ç</div>
                                <div class="calendar-day-header">–°—Ä</div>
                                <div class="calendar-day-header">–ß—Ç</div>
                                <div class="calendar-day-header">–ü—Ç</div>
                                <div class="calendar-day-header">–°–±</div>
                                <div class="calendar-day-header">–í—Å</div>
                            </div>

                            
                            <div class="calendar-body" id="monthCalendarBody">
                                
                            </div>
                        </div>
                    </div>

                    
                    <div id="weekView" class="calendar-view d-none">
                        <div class="week-view">
                            <div class="week-header" id="weekHeader">
                                
                            </div>
                            <div class="week-body" id="weekBody">
                                
                            </div>
                        </div>
                    </div>

                    
                    <div id="dayView" class="calendar-view d-none">
                        <div class="day-view">
                            <div class="day-view-header" id="dayHeader">
                                
                            </div>
                            <div class="day-view-body" id="dayBody">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        –ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è
                    </h5>
                </div>
                <div class="card-body">
                    {% if interviews %}
                        <div class="row">
                            {% for interview in interviews|slice:":6" %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card border-start border-4 
                                        {% if interview.status == 'scheduled' %}border-warning
                                        {% elif interview.status == 'confirmed' %}border-success
                                        {% else %}border-info{% endif %}">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="interview-time text-primary fw-bold">
                                                    {{ interview.scheduled_at|date:"d.m" }} –≤ {{ interview.scheduled_at|time:"H:i" }}
                                                </div>
                                                <span class="badge 
                                                    {% if interview.status == 'scheduled' %}bg-warning text-dark
                                                    {% elif interview.status == 'confirmed' %}bg-success
                                                    {% else %}bg-info{% endif %} badge-sm">
                                                    {{ interview.get_status_display }}
                                                </span>
                                            </div>
                                            <div class="fw-bold mb-1">{{ interview.candidate.full_name }}</div>
                                            <div class="text-muted small mb-2">{{ interview.application.job.title }}</div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    <i class="fas fa-{% if interview.format == 'online' %}video{% elif interview.format == 'phone' %}phone{% else %}building{% endif %} me-1"></i>
                                                    {{ interview.get_format_display }}
                                                </small>
                                                <a href="{% url 'calendar_app:interview_detail' interview.pk %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% if interviews|length > 6 %}
                            <div class="text-center">
                                <a href="{% url 'calendar_app:interview_list' %}" class="btn btn-outline-primary">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è
                                    <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5>–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h5>
                            <p class="text-muted">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus me-2"></i>
                    –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ó–∞—è–≤–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ <span class="text-danger">*</span></label>
                            <select name="application" class="form-select" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</option>
                                {% for application in pending_applications %}
                                    <option value="{{ application.id }}">
                                        {{ application.candidate.full_name }} - {{ application.job.title }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è <span class="text-danger">*</span></label>
                            <select name="interview_type" class="form-select" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                {% for interview_type in interview_types %}
                                    <option value="{{ interview_type.id }}" data-duration="{{ interview_type.duration_minutes }}">
                                        {{ interview_type.name }} ({{ interview_type.duration_minutes }} –º–∏–Ω)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–î–∞—Ç–∞ <span class="text-danger">*</span></label>
                            <input type="date" name="date" class="form-control" required min="{{ today|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–í—Ä–µ–º—è <span class="text-danger">*</span></label>
                            <input type="time" name="time" class="form-control" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä <span class="text-danger">*</span></label>
                            <select name="interviewer" class="form-select" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞</option>
                                {% for interviewer in interviewers %}
                                    <option value="{{ interviewer.id }}" {% if interviewer == request.user %}selected{% endif %}>
                                        {{ interviewer.get_full_name|default:interviewer.username }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–§–æ—Ä–º–∞—Ç <span class="text-danger">*</span></label>
                            <select name="format" class="form-select" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç</option>
                                <option value="online">üìπ –û–Ω–ª–∞–π–Ω</option>
                                <option value="offline">üè¢ –í –æ—Ñ–∏—Å–µ</option>
                                <option value="phone">üìû –¢–µ–ª–µ—Ñ–æ–Ω</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)</label>
                            <input type="number" name="duration" class="form-control" value="60" min="15" max="240" step="15">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ú–µ—Å—Ç–æ/–°—Å—ã–ª–∫–∞</label>
                            <input type="text" name="location" class="form-control" 
                                   placeholder="–ê–¥—Ä–µ—Å –æ—Ñ–∏—Å–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é">
                            <div class="form-text">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ó–∞–º–µ—Ç–∫–∏ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</label>
                        <textarea name="notes" class="form-control" rows="3" 
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é"></textarea>
                    </div>

                    
                    <div class="alert alert-info d-none" id="interviewPreview">
                        <h6><i class="fas fa-eye me-2"></i>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</h6>
                        <div id="previewContent"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" id="scheduleSubmitBtn">
                    <i class="fas fa-save me-1"></i>
                    –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
.calendar-grid {
    width: 100%;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.calendar-day-header {
    padding: 15px 10px;
    text-align: center;
    font-weight: 600;
    color: #495057;
    border-right: 1px solid #dee2e6;
}

.calendar-day-header:last-child {
    border-right: none;
}

.calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-auto-rows: minmax(120px, auto);
}

.calendar-day {
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    padding: 8px;
    position: relative;
    min-height: 120px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.calendar-day:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.calendar-day:last-child {
    border-right: none;
}

.calendar-day.today {
    background-color: rgba(13, 110, 253, 0.1);
}

.calendar-day.other-month {
    background-color: #f8f9fa;
    color: #adb5bd;
}

.day-number {
    font-weight: 600;
    margin-bottom: 5px;
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.event {
    background-color: #e3f2fd;
    border-left: 3px solid #2196f3;
    padding: 4px 6px;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
}

.event:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.event-scheduled {
    background-color: #fff8e1;
    border-left-color: #ff9800;
}

.event-confirmed {
    background-color: #e8f5e8;
    border-left-color: #4caf50;
}

.event-completed {
    background-color: #e1f5fe;
    border-left-color: #03a9f4;
}

.event-cancelled {
    background-color: #ffebee;
    border-left-color: #f44336;
}

.event-time {
    font-weight: 600;
    color: #333;
}

.event-title {
    font-weight: 500;
    margin: 1px 0;
}

.event-job {
    color: #666;
    font-size: 10px;
}

/* –ù–µ–¥–µ–ª—å–Ω—ã–π –≤–∏–¥ */
.week-view {
    width: 100%;
    overflow-x: auto;
}

.week-header {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
    border-bottom: 2px solid #dee2e6;
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 10;
}

.week-day-header {
    padding: 15px 10px;
    text-align: center;
    border-right: 1px solid #dee2e6;
}

.week-day-header.today {
    background-color: rgba(13, 110, 253, 0.1);
    color: var(--primary-color);
    font-weight: 600;
}

.week-body {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
}

.week-hour-row {
    display: contents;
}

.time-column {
    padding: 10px;
    border-right: 2px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    background-color: #f8f9fa;
    font-size: 0.85rem;
    color: #6c757d;
    text-align: center;
    font-weight: 600;
}

.week-hour-cell {
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    min-height: 60px;
    padding: 4px;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
}

.week-hour-cell:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

/* –î–Ω–µ–≤–Ω–æ–π –≤–∏–¥ */
.day-view {
    width: 100%;
}

.day-view-header {
    padding: 20px;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    text-align: center;
}

.day-hour-row {
    display: grid;
    grid-template-columns: 100px 1fr;
    min-height: 80px;
    border-bottom: 1px solid #dee2e6;
}

.day-time-column {
    padding: 20px 15px;
    border-right: 2px solid #dee2e6;
    background-color: #f8f9fa;
    font-weight: 600;
    color: #6c757d;
    text-align: center;
}

.day-hour-content {
    padding: 10px 15px;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
}

.day-hour-content:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.empty-hour {
    color: #adb5bd;
    font-style: italic;
    padding: 20px 0;
}

/* –°–æ–±—ã—Ç–∏—è –≤ —Ä–∞–∑–Ω—ã—Ö –≤–∏–¥–∞—Ö */
.event-detailed {
    margin-bottom: 8px;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.event-detailed:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.event-detailed .event-title {
    font-weight: 600;
    margin-bottom: 2px;
}

.event-detailed .event-job {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 2px;
}

.event-detailed .event-duration {
    font-size: 0.75rem;
    color: #888;
}

.badge-sm {
    font-size: 0.7rem;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .calendar-body {
        grid-auto-rows: minmax(80px, auto);
    }
    
    .calendar-day {
        min-height: 80px;
        padding: 4px;
    }
    
    .event {
        font-size: 10px;
        padding: 2px 4px;
    }
    
    .week-header, .week-body {
        grid-template-columns: 60px repeat(7, minmax(80px, 1fr));
    }
    
    .time-column, .day-time-column {
        font-size: 0.75rem;
        padding: 8px 4px;
    }
    
    .week-hour-cell {
        min-height: 40px;
        padding: 2px;
    }
    
    .event-detailed {
        font-size: 0.8rem;
        padding: 4px 6px;
    }
}

@media (max-width: 576px) {
    .calendar-day {
        min-height: 60px;
        padding: 2px;
    }
    
    .day-number {
        font-size: 0.9rem;
    }
    
    .event {
        font-size: 9px;
        padding: 1px 3px;
    }
    
    .week-header, .week-body {
        grid-template-columns: 50px repeat(7, minmax(60px, 1fr));
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
let currentDate = new Date();
let currentView = 'month';

// –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –∏ –¥–Ω–µ–π
const monthNames = [
    '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
    '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
];

const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
const dayNamesFull = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];

// –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏–π
const sampleEvents = [
    {
        id: 1,
        title: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
        job: 'Frontend Developer',
        date: new Date(2024, 11, 15, 10, 0),
        duration: 60,
        status: 'confirmed'
    },
    {
        id: 2,
        title: '–ê–Ω–Ω–∞ –°–∏–¥–æ—Ä–æ–≤–∞', 
        job: 'Backend Developer',
        date: new Date(2024, 11, 18, 14, 30),
        duration: 45,
        status: 'scheduled'
    },
    {
        id: 3,
        title: '–ü–µ—Ç—Ä –ò–≤–∞–Ω–æ–≤',
        job: 'DevOps Engineer', 
        date: new Date(2024, 11, 20, 11, 0),
        duration: 90,
        status: 'confirmed'
    },
    {
        id: 4,
        title: '–ú–∞—Ä–∏—è –ö–æ–∑–ª–æ–≤–∞',
        job: 'UI/UX Designer',
        date: new Date(2024, 11, 22, 15, 0),
        duration: 45,
        status: 'scheduled'
    }
];

document.addEventListener('DOMContentLoaded', function() {
    initCalendar();
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    document.getElementById('prevMonthBtn').addEventListener('click', navigatePrevious);
    document.getElementById('nextMonthBtn').addEventListener('click', navigateNext);
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–æ–≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    document.querySelectorAll('[data-view]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('[data-view]').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            currentView = this.dataset.view;
            switchCalendarView();
        });
    });
    
    addTodayButton();
});

function initCalendar() {
    generateMonthCalendar();
    updateTitle();
}

function navigatePrevious() {
    switch(currentView) {
        case 'month':
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateMonthCalendar();
            break;
        case 'week':
            currentDate.setDate(currentDate.getDate() - 7);
            generateWeekCalendar();
            break;
        case 'day':
            currentDate.setDate(currentDate.getDate() - 1);
            generateDayCalendar();
            break;
    }
    updateTitle();
}

function navigateNext() {
    switch(currentView) {
        case 'month':
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateMonthCalendar();
            break;
        case 'week':
            currentDate.setDate(currentDate.getDate() + 7);
            generateWeekCalendar();
            break;
        case 'day':
            currentDate.setDate(currentDate.getDate() + 1);
            generateDayCalendar();
            break;
    }
    updateTitle();
}

function switchCalendarView() {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∏–¥—ã
    document.querySelectorAll('.calendar-view').forEach(view => {
        view.classList.add('d-none');
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—ã–π –≤–∏–¥
    switch(currentView) {
        case 'month':
            document.getElementById('monthView').classList.remove('d-none');
            generateMonthCalendar();
            break;
        case 'week':
            document.getElementById('weekView').classList.remove('d-none');
            generateWeekCalendar();
            break;
        case 'day':
            document.getElementById('dayView').classList.remove('d-none');
            generateDayCalendar();
            break;
    }
    updateTitle();
}

function updateTitle() {
    const monthYearElement = document.getElementById('currentMonthYear');
    
    switch(currentView) {
        case 'month':
            monthYearElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            break;
        case 'week':
            const weekStart = getWeekStart(currentDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            monthYearElement.textContent = `${weekStart.getDate()}-${weekEnd.getDate()} ${monthNames[weekStart.getMonth()]} ${weekStart.getFullYear()}`;
            break;
        case 'day':
            monthYearElement.textContent = `${currentDate.getDate()} ${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            break;
    }
}

function generateMonthCalendar() {
    const calendarBody = document.getElementById('monthCalendarBody');
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = getWeekStart(firstDay);
    
    const eventsForMonth = getEventsForPeriod(firstDay, lastDay);
    
    let html = '';
    const currentDateObj = new Date(startDate);
    
    for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
            const isCurrentMonth = currentDateObj.getMonth() === currentDate.getMonth();
            const isToday = isDateToday(currentDateObj);
            const dayEvents = eventsForMonth.filter(event => isSameDay(event.date, currentDateObj));
            
            html += `
                <div class="calendar-day ${isToday ? 'today' : ''} ${!isCurrentMonth ? 'other-month' : ''}" 
                     data-date="${currentDateObj.toISOString().split('T')[0]}">
                    <div class="day-number">${currentDateObj.getDate()}</div>
                    <div class="day-events">
                        ${dayEvents.map(event => generateEventHtml(event, 'month')).join('')}
                    </div>
                </div>
            `;
            
            currentDateObj.setDate(currentDateObj.getDate() + 1);
        }
        
        if (currentDateObj.getMonth() !== currentDate.getMonth() && 
            currentDateObj.getMonth() !== (currentDate.getMonth() + 1) % 12) {
            break;
        }
    }
    
    calendarBody.innerHTML = html;
}

function generateWeekCalendar() {
    const weekStart = getWeekStart(currentDate);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    const eventsForWeek = getEventsForPeriod(weekStart, weekEnd);
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ–¥–µ–ª–∏
    const weekHeader = document.getElementById('weekHeader');
    let headerHtml = '<div class="time-column"></div>';
    
    for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(day.getDate() + i);
        const isToday = isDateToday(day);
        
        headerHtml += `
            <div class="week-day-header ${isToday ? 'today' : ''}">
                <div class="day-name">${dayNames[i]}</div>
                <div class="day-number">${day.getDate()}</div>
            </div>
        `;
    }
    weekHeader.innerHTML = headerHtml;
    
    // –¢–µ–ª–æ –Ω–µ–¥–µ–ª–∏
    const weekBody = document.getElementById('weekBody');
    let bodyHtml = '';
    
    for (let hour = 8; hour <= 18; hour++) {
        bodyHtml += `
            <div class="week-hour-row">
                <div class="time-column">${hour.toString().padStart(2, '0')}:00</div>
        `;
        
        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
            const day = new Date(weekStart);
            day.setDate(day.getDate() + dayIndex);
            day.setHours(hour, 0, 0, 0);
            
            const hourEvents = eventsForWeek.filter(event => 
                isSameDay(event.date, day) && event.date.getHours() === hour
            );
            
            bodyHtml += `
                <div class="week-hour-cell" data-datetime="${day.toISOString()}">
                    ${hourEvents.map(event => generateEventHtml(event, 'week')).join('')}
                </div>
            `;
        }
        
        bodyHtml += '</div>';
    }
    
    weekBody.innerHTML = bodyHtml;
}

function generateDayCalendar() {
    const dayStart = new Date(currentDate);
    dayStart.setHours(0, 0, 0, 0);
    const dayEnd = new Date(currentDate);
    dayEnd.setHours(23, 59, 59, 999);
    const eventsForDay = getEventsForPeriod(dayStart, dayEnd);
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è
    const dayHeader = document.getElementById('dayHeader');
    const dayName = dayNamesFull[currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1];
    dayHeader.innerHTML = `<h5>${dayName}, ${currentDate.getDate()} ${monthNames[currentDate.getMonth()]}</h5>`;
    
    // –¢–µ–ª–æ –¥–Ω—è
    const dayBody = document.getElementById('dayBody');
    let bodyHtml = '';
    
    for (let hour = 8; hour <= 18; hour++) {
        const hourEvents = eventsForDay.filter(event => event.date.getHours() === hour);
        
        bodyHtml += `
            <div class="day-hour-row">
                <div class="day-time-column">${hour.toString().padStart(2, '0')}:00</div>
                <div class="day-hour-content">
                    ${hourEvents.map(event => generateEventHtml(event, 'day')).join('')}
                    ${hourEvents.length === 0 ? '<div class="empty-hour">–°–≤–æ–±–æ–¥–Ω–æ</div>' : ''}
                </div>
            </div>
        `;
    }
    
    dayBody.innerHTML = bodyHtml;
}

function generateEventHtml(event, viewType) {
    const statusClasses = {
        'scheduled': 'event-scheduled',
        'confirmed': 'event-confirmed',
        'completed': 'event-completed',
        'cancelled': 'event-cancelled'
    };
    
    const timeStr = event.date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    switch(viewType) {
        case 'month':
            return `
                <div class="event ${statusClasses[event.status]}" data-event-id="${event.id}">
                    <div class="event-time">${timeStr}</div>
                    <div class="event-title">${event.title}</div>
                </div>
            `;
        case 'week':
        case 'day':
            return `
                <div class="event ${statusClasses[event.status]} event-detailed" data-event-id="${event.id}">
                    <div class="event-time">${timeStr}</div>
                    <div class="event-title">${event.title}</div>
                    <div class="event-job">${event.job}</div>
                    <div class="event-duration">${event.duration} –º–∏–Ω</div>
                </div>
            `;
        default:
            return '';
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
}

function isDateToday(date) {
    const today = new Date();
    return date.getDate() === today.getDate() &&
           date.getMonth() === today.getMonth() &&
           date.getFullYear() === today.getFullYear();
}

function isSameDay(date1, date2) {
    return date1.getDate() === date2.getDate() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getFullYear() === date2.getFullYear();
}

function getEventsForPeriod(startDate, endDate) {
    return sampleEvents.filter(event => 
        event.date >= startDate && event.date <= endDate
    );
}

function goToToday() {
    currentDate = new Date();
    switchCalendarView();
}

function addTodayButton() {
    const navContainer = document.querySelector('.row.align-items-center .col-auto:last-child');
    if (navContainer) {
        const todayBtn = document.createElement('button');
        todayBtn.className = 'btn btn-outline-info btn-sm ms-2';
        todayBtn.innerHTML = '<i class="fas fa-calendar-day me-1"></i>–°–µ–≥–æ–¥–Ω—è';
        todayBtn.onclick = goToToday;
        navContainer.appendChild(todayBtn);
    }
}

// –†–∞–±–æ—Ç–∞ —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const scheduleForm = document.getElementById('scheduleForm');
    const submitBtn = document.getElementById('scheduleSubmitBtn');
    const previewDiv = document.getElementById('interviewPreview');
    const previewContent = document.getElementById('previewContent');
    
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è
    const interviewTypeSelect = scheduleForm.querySelector('[name="interview_type"]');
    const durationInput = scheduleForm.querySelector('[name="duration"]');
    
    interviewTypeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.duration) {
            durationInput.value = selectedOption.dataset.duration;
        }
        updatePreview();
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    function updatePreview() {
        const formData = new FormData(scheduleForm);
        const application = scheduleForm.querySelector('[name="application"]');
        const interviewType = scheduleForm.querySelector('[name="interview_type"]');
        const date = formData.get('date');
        const time = formData.get('time');
        const format = formData.get('format');
        
        if (application.value && interviewType.value && date && time) {
            const selectedApp = application.options[application.selectedIndex].text;
            const selectedType = interviewType.options[interviewType.selectedIndex].text;
            const selectedFormat = scheduleForm.querySelector('[name="format"]').options[scheduleForm.querySelector('[name="format"]').selectedIndex].text;
            
            previewContent.innerHTML = `
                <strong>–ö–∞–Ω–¥–∏–¥–∞—Ç:</strong> ${selectedApp}<br>
                <strong>–¢–∏–ø:</strong> ${selectedType}<br>
                <strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> ${formatDate(date)} –≤ ${time}<br>
                <strong>–§–æ—Ä–º–∞—Ç:</strong> ${selectedFormat}
            `;
            previewDiv.classList.remove('d-none');
        } else {
            previewDiv.classList.add('d-none');
        }
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
    scheduleForm.addEventListener('change', updatePreview);
    scheduleForm.addEventListener('input', updatePreview);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    submitBtn.addEventListener('click', function() {
        if (scheduleForm.checkValidity()) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–°–æ–∑–¥–∞–Ω–∏–µ...';
            
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–∞
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            setTimeout(() => {
                alert('–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ! (–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
                const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                modal.hide();
                scheduleForm.reset();
                previewDiv.classList.add('d-none');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ';
            }, 1000);
        } else {
            scheduleForm.reportValidity();
        }
    });
    
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('scheduleModal').addEventListener('hidden.bs.modal', function() {
        scheduleForm.reset();
        previewDiv.classList.add('d-none');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ';
    });
});

function showEventDetails(eventId) {
    const event = sampleEvents.find(e => e.id == eventId);
    if (event) {
        alert(`–°–æ–±—ã—Ç–∏–µ: ${event.title}\n–í–∞–∫–∞–Ω—Å–∏—è: ${event.job}\n–í—Ä–µ–º—è: ${event.date.toLocaleString('ru-RU')}\n–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${event.duration} –º–∏–Ω`);
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ—Ç–∞–ª–µ–π
    }
}
</script>
{% endblock %}
